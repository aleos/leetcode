name: Build and Test

on:
  workflow_dispatch:
  workflow_call:
    outputs:
      report-file:
        value: ${{ jobs.test.outputs.report-file }}
      coverage-artifact:
        value: ${{ jobs.test.outputs.coverage-artifact }}

jobs:
  test:
    name: Build and Test
    runs-on: macos-26
    defaults:
      run:
        working-directory: swift
    env:
      REPORT: coverage.json
      ARTIFACT: coverage-results
    outputs:
      report-file: ${{ steps.export.outputs.report }}
      coverage-artifact: ${{ steps.export.outputs.artifact }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Restore file mtimes
        uses: chetan/git-restore-mtime-action@v2

      - name: Cache SPM
        uses: actions/cache@v5
        with:
          path: |
            swift/.build/Build
            swift/.build/SourcePackages
          key: xcode-${{ runner.os }}-${{ hashFiles('swift/Package.resolved') }}-${{ github.sha }}
          restore-keys: |
            xcode-${{ runner.os }}-${{ hashFiles('swift/Package.resolved') }}-

      - name: Run tests
        run: |
          set -o pipefail && xcodebuild test \
            -scheme LeetCode \
            -testPlan LeetCode \
            -destination 'platform=macOS' \
            -enableCodeCoverage YES \
            -derivedDataPath .build/ \
            IgnoreFileSystemDeviceInodeChanges=YES | xcbeautify

      - name: Export coverage
        run: |
          RESULT_BUNDLE=$(find .build/Logs/Test -name "*.xcresult" | head -n 1)
          echo "Found result bundle: $RESULT_BUNDLE"
          xcrun xccov view --report --json "$RESULT_BUNDLE" > "$REPORT"
          echo "Coverage: $(jq -r '.lineCoverage * 100 | round' "$REPORT")%"

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT }}
          path: swift/${{ env.REPORT }}
          retention-days: 7

      - name: Export outputs
        id: export
        run: |
          echo "report=$REPORT" >> $GITHUB_OUTPUT
          echo "artifact=$ARTIFACT" >> $GITHUB_OUTPUT
          echo "Exported: report=$REPORT, artifact=$ARTIFACT"
